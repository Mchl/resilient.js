/*! resilient - v0.1 - MIT License - https://github.com/resilient-http/resilient.js */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.resilient=t()}}(function(){var t,e,r;return function n(t,e,r){function i(o,u){if(!e[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(s)return s(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var c=e[o]={exports:{}};t[o][0].call(c.exports,function(e){var r=t[o][1][e];return i(r?r:e)},c,c.exports,n,t,e,r)}return e[o].exports}var s=typeof require=="function"&&require;for(var o=0;o<r.length;o++)i(r[o]);return i}({1:[function(e,r,n){(function(e,i){if(typeof t==="function"&&t.amd){t(["exports"],i)}else if(typeof n==="object"){i(n);if(typeof r==="object"&&r!==null){r.exports=n=n.http}}else{i(e.lil=e.lil||{})}})(this,function(t){"use strict";var e="0.1.8";var r=Object.prototype.toString;var n=Array.prototype.slice;var i=Object.prototype.hasOwnProperty;var s=location.origin;var o=/^(http[s]?:\/\/[a-z0-9\-\.\:]+)[\/]?/i;var u=typeof XDomainRequest!=="undefined";var a=function(){};var f={method:"GET",timeout:30*1e3,auth:null,headers:null,async:true,withCredentials:false,responseType:"text"};function c(t){return t&&r.call(t)==="[object Object]"||false}function l(t){return t&&r.call(t)==="[object Array]"||false}function p(t){var e,r,s,o,u=n.call(arguments).slice(1);for(e=0,r=u.length;e<r;e+=1){o=u[e];for(s in o)if(i.call(o,s))t[s]=o[s]}return t}function v(t,e){if(c(e)){e["Content-Type"]=e["Content-Type"]||j.defaultContent;for(var r in e){t.setRequestHeader(r,e[r])}}}function h(t){var e={},r=t.getAllResponseHeaders().split("\n");r.forEach(function(t){if(t){t=t.split(":");e[t[0].trim()]=(t[1]||"").trim()}});return e}function d(t){var e,r=t.getResponseHeader("Content-Type");if(t.responseType==="text"){e=t.responseText;if(r==="application/json"&&e)e=JSON.parse(e)}else{e=t.response}return e}function y(t){return{xhr:t,status:t.status,data:d(t),headers:h(t)}}function g(t,e){var r=new Error(e.message);p(r,y(t));r.error=e;r.stack=e.stack;return r}function O(t,e){var r=false;return function(n){if(!r){e(g(t,n),null);r=true}}}function w(t,e){return function(){if(t.readyState===4){if(t.status>=200&&t.status<400){e(null,y(t))}else{e(y(t),null)}}}}function b(t){var e=t.match(o);return e&&e[1]===s}function m(t){var e=null;var r=(t.method||"GET").toUpperCase();var n=t.auth||{};var i=t.url;if(u&&b(i)){e=new XDomainRequest}else{e=new XMLHttpRequest}e.open(r,i,t.async,n.user,n.password);e.withCredentials=t.withCredentials;e.responseType=t.responseType;e.timeout=t.timeout;v(e,t.headers);return e}function E(t,e){return function(t){if(evt.lengthComputable){e(t,evt.loaded/evt.total)}else{e(t)}}}function x(t,e,r){var n=m(t);var i=c(t.data)||l(t.data)?JSON.stringify(t.data):t.data;var s=O(n,e);n.onload=w(n,e);n.onerror=s;n.ontimeout=s;n.onabort=s;if(typeof r==="function")n.onprogress=E(n,r);try{n.send(i)}catch(o){s(o)}return{xhr:n,config:t}}function S(t){return function(e,r,i,s){var o,u,l=null;var v=p({},f,{method:t});var h=n.call(arguments);for(o=0,u=h.length;o<u;o+=1){l=h[o];if(typeof l==="function"){i=l;if(i!==l)s=l}else if(c(l)){p(v,l)}else if(typeof l==="string"&&!v.url){v.url=l}}return x(v,i||a,s)}}function j(t,e,r,n){return S("GET").apply(null,arguments)}j.VERSION=e;j.defaults=f;j.defaultContent="text/plain";j.get=S("GET");j.post=S("POST");j.put=S("PUT");j.del=S("DELETE");j.patch=S("PATCH");j.head=S("HEAD");return t.http=j})},{}],2:[function(t,e,r){var n=t("./utils");e.exports=i;function i(){this.store={}}i.prototype.flush=function(t){if(t){this.store[t]=null}else{this.store={}}};i.prototype.get=function(t){return t?this.store[t]:n.clone(this.store)};i.prototype.time=function(t){if(t&&this.store[t]){return this.store[t].time}};i.prototype.set=function(t,e){if(t&&e){this.store[t]={data:e,time:n.now()}}}},{"./utils":16}],3:[function(t,e,r){var n=t("./utils");var i=t("./resolver");var s=t("./http");e.exports=o;function o(t){this._resilient=t}o.prototype.send=function(t,e,r,n){var s=u.call(this,t,e,r,n);if(f(s[0])){return c.apply(null,s)}else{return i.apply(null,[this._resilient].concat(s))}};o.prototype.get=function(t,e,r){return this.send(t,e,r,"GET")};o.prototype.post=function(t,e,r){return this.send(t,e,r,"POST")};o.prototype.put=function(t,e,r){return this.send(t,e,r,"PUT")};o.prototype.del=function(t,e,r){return this.send(t,e,r,"DELETE")};o.prototype.patch=function(t,e,r){return this.send(t,e,r,"PATCH")};o.prototype.head=function(t,e,r){return this.send(t,e,r,"HEAD")};function u(t,e,r,i){if(typeof e==="function"){r=e;e=arguments[1]}e=a.call(this,e);if(typeof t==="string")e.path=t;if(typeof i==="string")e.method=i;if(typeof r!=="function")r=n.noop;return[e,r]}function a(t){var e=this._resilient.getHttpOptions();return n.extend(e,t)}function f(t){return t&&(n.isURI(t.path)||n.isURI(t.url))||false}function c(t,e){t.url=t.path;return s.call(null,t,e)}},{"./http":8,"./resolver":13,"./utils":16}],4:[function(t,e,r){var n=e.exports={};n.service={method:"GET",timeout:2*1e3,servers:null,retry:0,updateOnRetry:true,refresh:60*1e3};n.balancer={enable:true,weight:{request:25,error:50,latency:25}};n.discovery={servers:null,method:"GET",cache:true,retry:0,retryWait:1e3,timeout:2*1e3,parallel:false,updateOnRetry:false,cacheExpiration:60*10*1e3};n.resilientOptions=["servers","retry","retryWait","parallel","cacheExpiration","cache","refresh","updateOnRetry"]},{}],5:[function(t,e,r){var n=t("./utils");var i=t("./error");var s=t("./servers");var o=t("./requester");var u=t("./discovery-servers");e.exports=a;function a(t){function e(){return t.getOptions("discovery")}function r(){return e().servers()}function n(){return t._updating}function u(){var t=r();return t&&t.exists()||false}function a(r){var s=e().get();if(!u()){r(new i(1002))}else if(n()){t._queue.push(r)}else{p(s,r)}}function p(e,r){try{v(e,r)}catch(n){t._updating=false;r(new i(1006,n))}}function v(e,n){t._updating=true;e.path=f(e.path);if(e.parallel){h(e,n)}else{o(t)(r(),e,y(n))}}function h(e,n){var i=[],u=r().sort();u.slice(0,3).forEach(function(r,a){r=[r];if(a===2&&u.length>3){r=r.concat(u.slice(3))}e.retry=0;o(t)(new s(r),e,d(a,i,n),i)})}function d(t,e,r){return function(n,i){if(n)e[t]=null;if(i||l(e)){y(r,e)(n,i)}}}function y(e,r){return function(n,i){t._updating=false;t._queue.forEach(function(t){t(n,i)});t._queue.splice(0);if(r)g(r);if(n)e(n);else e(null,i)}}function g(t){t.forEach(function(t){try{c(t)}catch(e){}});t.splice(0)}return a}o.DiscoveryResolver=a;a.update=function(t,e){a(t)(u(t)(e))};a.fetch=function(t,e){a(t)(function(t,r){if(t)e(t);else{if(r&&r.data)e(null,r.data);else e(new i(1001,r))}})};function f(t){t=t||"";t+=t.indexOf("?")===-1?"?":"&";t+=n.now()+Math.floor(Math.random()*1e4);return t}function c(t){if(t){if(t.xhr){if(t.xhr.readyState!==4)t.xhr.abort()}else{t.abort()}}}function l(t){return!t||t.filter(function(t){return n.isObj(t)}).length===0}},{"./discovery-servers":6,"./error":7,"./requester":11,"./servers":15,"./utils":16}],6:[function(t,e,r){var n=t("./utils");var i=t("./error");e.exports=s;function s(t){function e(t){return function(e,n){if(!e&&u(n)){r(n,t)}else{s(e,t)}}}function r(e,r){if(e.data.length){t.setServers(e.data);f(e.data);r(null,e)}else{r(new i(1004,e))}}function s(t,e){if(c()){a(t,e)}else{o(t,e)}}function a(e,r){var i,s=l();if(s&&n.isArr(s.data)){i=t.getOptions("discovery").cacheExpiration;if(n.now()-s.time>i){r(null,{status:200,_cache:true,data:s.data})}else{t._cache.flush("discovery");o(e,r)}}else{o(e,r)}}function f(e){if(c()){t._cache.set("discovery",e)}}function c(){return t.getOptions("discovery").cache}function l(){return t._cache.get("discovery")}return e}function o(t,e){t=t||{status:1e3};return e(new i(t.status,t))}function u(t){return t&&n.isArr(t.data)||false}},{"./error":7,"./utils":16}],7:[function(t,e,r){e.exports=i;var n={1e3:"All requests failed. No servers available",1001:"Cannot update discovery servers. Empty or invalid response body",1002:"Missing discovery servers. Cannot resolve the server",1003:"Cannot resolve servers. Missing data",1004:"Discovery server response is invalid or empty",1005:"Missing discovery servers during retry process",1006:"Internal state error"};function i(t,e){if(e instanceof Error){Error.call(this,e);this.error=e;if(e.code)this.code=e.code;if(e.stack)this.stack=e.stack}else if(e){this.request=e}this.status=t||1e3;this.message=n[this.status]}i.prototype=Object.create(Error.prototype);i.MESSAGES=n},{}],8:[function(t,e,r){var n=s();e.exports=i;function i(){return n.apply(null,arguments)}i.VERSION=n.VERSION;function s(){if(typeof window==="object"&&window){return t("../bower_components/lil-http/http")}else{return o(t("request"))}}function o(t){return function(e,r){if(typeof e==="string")e={url:e};e=f(e);if(e.data)e.body=e.data;return t.call(null,e,u(r))}}function u(t){return function(e,r,n){if(r){r.status=r.statusCode;if(n){r.data=a(r)?JSON.parse(n):n}}t(e,r)}}function a(t){return t.headers["content-type"]==="application/json"}function f(t){t=t||{};t.headers=t.headers||{};t.headers["User-Agent"]=t.headers["User-Agent"]||c();return t}function c(){return"resilient-http "+i.LIBRARY_VERSION+" (node)"}},{"../bower_components/lil-http/http":1,request:17}],9:[function(t,e,r){var n=t("./resilient");var i=t("./options");var s=t("./defaults");var o=t("./servers");var u=t("./client");var a=t("./http");e.exports=f;function f(t){return new n(t)}f.VERSION="0.1.0-beta.1";f.CLIENT_VERSION=a.VERSION;f.defaults=s;f.Options=i;f.Servers=o;f.Client=u;f.request=a;a.LIBRARY_VERSION=f.VERSION},{"./client":3,"./defaults":4,"./http":8,"./options":10,"./resilient":12,"./servers":15}],10:[function(t,e,r){var n=t("./utils");var i=t("./defaults");var s=t("./servers");e.exports=o;function o(t,e){this.store=e?n.clone(i[e]):{};this.set(t)}o.prototype.get=function(t){return t?this.store[t]:n.clone(this.store)};o.prototype.getRaw=function(){var t={},e=this.get();if(e){n.each(e,function(e,r){if(r instanceof o){t[e]=r.get()}})}return t};o.prototype.set=function(t,e){if(n.isObj(t)){n.each(t,n.bind(this,this.set))}else if(e!==undefined){if(t==="servers"){this.setServers(e)}else{this.store[t]=e}}};o.prototype.http=function(){return n.omit(this.store,i.resilientOptions)};o.prototype.servers=function(t){return t?this.setServers(t):this.store.servers};o.prototype.setServers=function(t){if(this.store.servers){this.store.servers.set(t)}else{this.store.servers=new s(t)}};o.prototype.clone=function(){return o.define(this.getRaw())};o.define=function(t,e){var r=new o;e=n.clone(e||i);Object.keys(e).forEach(u(t,r));return r};function u(t,e){t=n.isObj(t)?t:{};return function(r){if(r!=="resilientOptions"){e.set(r,new o(t[r],r))}}}},{"./defaults":4,"./servers":15,"./utils":16}],11:[function(t,e,r){var n=t("./utils");var i=t("./http");var s=t("./defaults").resilientOptions;var o=t("./error");var u=t("./discovery-servers");e.exports=a;function a(t){function e(e,r){if(t.balancer().enabled){return e.servers.slice()}else{return e.sort(r)}}function r(t,r,s,o){var u=v(r.method);var a=e(t,u);r=n.clone(r);function l(e){var p,v=a.shift();if(v){p=f(v,u,s,l);r.url=n.join(v.url,r.basePath,r.path);c(r,p,o)}else{i(t,r,e,s)}}l()}function i(e,r,n,i){var u=null;if(r.retry){u=s(e,r,i);if(r.updateOnRetry){t._updating=false;a.DiscoveryResolver.update(t,u)}else{u()}}else{i(new o(1e3,n))}}function s(t,e,r){return function(){n.delay(u(t,e,r),e.retryWait)}}function u(e,n,i){return function(){var s=t.discoveryServers();if(s&&s.exists()){n.retry-=1;r(e,n,i)}else{i(new o(1005))}}}function l(e){return t.options.get(e||"service")}return r}function f(t,e,r,i){var s=n.now();return function(o,u){var a=n.now()-s;if(l(o,u)||u==undefined){t.reportError(e,a);i(o)}else{t.report(e,a);r(null,u)}}}function c(t,e,r){var o=null;try{o=i(n.omit(t,s),e);if(r)r.push(o)}catch(u){e(u)}t=r=null}function l(t,e){if(t){return t.code!==undefined||p(t)}else if(n.isObj(e)){return p(e)}}function p(t){return t.status>=429||t.status===0}function v(t){return!t||t.toUpperCase()==="GET"?"read":"write"}},{"./defaults":4,"./discovery-servers":6,"./error":7,"./http":8,"./utils":16}],12:[function(t,e,r){var n=t("./utils");var i=t("./options");var s=t("./client");var o=t("./cache");var u=t("./discovery-resolver");var a=["get","post","put","del","head","patch"];e.exports=f;function f(t){this._queue=[];this._updating=false;this._client=new s(this);this._cache=new o;this.setOptions(t)}f.prototype.setOptions=function(t,e){var r=null;if(t&&n.isObj(e)){r=this.options.get(t);if(r instanceof i)r.set(e)}else{this.options=i.define(t)}};f.prototype.setDiscoveryOptions=function(t){this.setOptions("discovery",t);return this};f.prototype.setServiceOptions=function(t){this.setOptions("service",t);return this};f.prototype.getOptions=function(t){return t?this.options.get(t):this.options};f.prototype.getHttpOptions=function(t){var e=this.options.get(t||"service");if(e)return e.http()};f.prototype.getServers=function(t){var e=this.options.get(t||"service");if(e)return e.servers()};f.prototype.discoveryServers=function(t){if(n.isArr(t)){this.options.get("discovery").servers(t)}else{return this.getServers("discovery")}};f.prototype.setServers=function(t){this.options.get("service").servers(t);return this};f.prototype.discoverServers=function(t){u.fetch(this,t);return this};f.prototype.updateServers=function(t){u.update(this,t||n.noop);return this};f.prototype.flushCache=function(){this._cache.flush();return this};f.prototype.areServersUpdated=function(){return this.getServers("service").lastUpdate()<(this.getOptions("service").get("refresh")||0)};f.prototype.balancer=function(){return this.getOptions("balancer")};f.prototype.client=function(){return this._client};f.prototype.send=f.prototype.request=function(t,e,r){return this._client.send(t,e,r)};a.forEach(c);function c(t){f.prototype[t]=function(e,r,n){return this._client[t](e,r,n)}}},{"./cache":2,"./client":3,"./discovery-resolver":5,"./options":10,"./utils":16}],13:[function(t,e,r){var n=t("./utils");var i=t("./error");var s=t("./requester");var o=t("./discovery-resolver");var u=t("./servers");e.exports=a;function a(t,e,r){try{a(l)}catch(n){r(new i(1006,n))}function a(e){if(f()){e()}else{if(f("discovery")){o.update(t,e)}else{e(new i(1002))}}}function f(e){var r,n=false;e=e||"service";r=t.getServers(e);if(r&&r.exists()){n=e!=="discovery"?c(r,e):true}return n}function c(e,r){return e.lastUpdate()<(t.getOptions(r).get("refresh")||0)}function l(t,e){if(t){r(t)}else{p(e)}}function p(n){var o=t.getServers();if(n&&n._cache){o=new u(n.data)}else if(!f()){return r(new i(1003))}s(t)(o,e,r)}}},{"./discovery-resolver":5,"./error":7,"./requester":11,"./servers":15,"./utils":16}],14:[function(t,e,r){var n=t("./utils");var i=t("./defaults");e.exports=s;function s(t,e){this.url=t;this.setStats();this.setOptions(e)}s.prototype.report=function(t,e,r){var n=this.getStats(t);if(n){n[r||"request"]+=1;if(e){n.latency=u(e,n)}}};s.prototype.reportError=function(t,e){this.report(t,e,"error")};s.prototype.getBalance=function(t){var e=this.getStats(t);var r=e.request+e.error;var n=this.options.weight;var i=r===0?0:a((e.request*100/r*n.request+e.error*100/r*n.error+e.latency*n.latency)/100);return i};s.prototype.getStats=function(t,e){var r=this.stats[t||"read"];if(r&&e)r=r[e];return r};s.prototype.setOptions=function(t){this.options=n.extend({},i.balancer,t)};s.prototype.setStats=function(t){this.stats=t||{read:o(),write:o()}};function o(){return{latency:0,error:0,request:0}}function u(t,e){return a((t+e.latency)/(e.request+e.error))}function a(t){return Math.round(t*100)/100}},{"./defaults":4,"./utils":16}],15:[function(t,e,r){var n=t("./utils");var i=t("./server");e.exports=s;function s(t){this.servers=[];this.updated=0;this.set(t)}s.prototype.sort=function(t){return this.servers.slice(0).sort(function(e,r){return e.getBalance(t)-r.getBalance(t)})};s.prototype.find=function(t){var e,r,n=null;for(e=0,r=this.servers.length;e<r;e+=1){if(this.servers[e].url===t){n=this.servers[e];break}}return n};s.prototype.set=function(t){if(n.isArr(t)){this.updated=n.now();this.servers=u.call(this,t)}};s.prototype.lastUpdate=function(){return n.now()-this.updated};s.prototype.empty=function(){return this.servers.length===0};s.prototype.exists=function(){return this.servers.length>0};function o(t){if(n.isObj(t))t=t.url||t.uri;return n.isURI(t)}function u(t){return t.filter(o).map(n.bind(this,a))}function a(t){var e;if(t instanceof i){e=t}else{e=this.find(n.isObj(t)?t.url:t);if(!e)e=new i(t)}return e}},{"./server":14,"./utils":16}],16:[function(t,e,r){var n=r;var i=Object.prototype.toString;var s=Array.prototype.slice;var o=Object.prototype.hasOwnProperty;var u=Function.prototype.bind;var a=Array.isArray;var f=/^http[s]?\:\/\/(.+)/i;n.noop=function(){};n.now=function(){return(new Date).getTime()};n.isObj=function(t){return t&&i.call(t)==="[object Object]"||false};n.isArr=function(t){return t&&a?a(t):i.call(t)==="[object Array]"||false};n.bind=function(t,e){return u?e.bind(t):function(){return e.apply(t,arguments)}};n.each=function(t,e){var r,i;if(n.isArr(t))for(r=0,i=t.length;r<i;r+=1)e(t[r],r);else if(n.isObj(t))for(r in t)if(o.call(t,r))e(r,t[r])};n.extend=function(t){var e=s.call(arguments,1);n.each(e,function(e){if(n.isObj(e)){n.each(e,function(e,r){t[e]=r})}});return t};n.clone=function(t){return n.extend({},t)};n.omit=function(t,e){var r,i={};if(n.isObj(t)){for(r in t)if(o.call(t,r)){if(e.indexOf(r)===-1)i[r]=t[r]}}return i};n.delay=function(t,e){return setTimeout(t,e||1)};n.isURI=function(t){return typeof t==="string"&&f.test(t)};n.join=function(t){return(t||"")+s.call(arguments,1).filter(function(t){return typeof t==="string"&&t.length>0}).join("")}},{}],17:[function(t,e,r){},{}]},{},[9])(9)});
//# sourceMappingURL=resilient.min.js.map