/*! resilient - v0.3.0 - MIT License - https://github.com/resilient-http/resilient.js */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.resilient=t()}}(function(){var t,e,r;return function n(t,e,r){function i(s,u){if(!e[s]){if(!t[s]){var f=typeof require=="function"&&require;if(!u&&f)return f(s,!0);if(o)return o(s,!0);var a=new Error("Cannot find module '"+s+"'");throw a.code="MODULE_NOT_FOUND",a}var c=e[s]={exports:{}};t[s][0].call(c.exports,function(e){var r=t[s][1][e];return i(r?r:e)},c,c.exports,n,t,e,r)}return e[s].exports}var o=typeof require=="function"&&require;for(var s=0;s<r.length;s++)i(r[s]);return i}({1:[function(t,e,r){var n=t("./utils");e.exports=i;function i(){this.store=Object.create(null)}i.prototype.flush=function(t){if(t){this.store[t]=null}else{this.store=n.emptyObject()}};i.prototype.get=function(t){return t?this.store[t]:n.clone(this.store)};i.prototype.set=function(t,e){if(t){this.store[t]={data:e,time:n.now()}}};i.prototype.time=function(t){var e=this.store[t];return e?e.time:null};i.prototype.exists=function(t){var e=this.store[t];return n.isObj(e)&&(n.isArr(e.data)&&e.data.length>0||n.isObj(e.data))||false}},{"./utils":20}],2:[function(t,e,r){var n=t("./utils");var i=t("./resolver");var o=t("./http");e.exports=s;function s(t){this._resilient=t}s.prototype.get=function(t,e,r){return this.send(t,e,r,"GET")};s.prototype.post=function(t,e,r){return this.send(t,e,r,"POST")};s.prototype.put=function(t,e,r){return this.send(t,e,r,"PUT")};s.prototype.del=s.prototype.delete=function(t,e,r){return this.send(t,e,r,"DELETE")};s.prototype.patch=function(t,e,r){return this.send(t,e,r,"PATCH")};s.prototype.head=function(t,e,r){return this.send(t,e,r,"HEAD")};s.prototype.send=function(t,e,r,n){var i=f.call(this,t,e,r,n);u.apply(this,i);return this};function u(t,e){this._resilient.emit("request:start",t,this._resilient);if(l(t)){return p(this._resilient,t,e)}else{return i(this._resilient,t,e)}}function f(t,e,r,i){if(typeof e==="function"){r=e;e=arguments[0]}e=c(this._resilient,n.isObj(e)?e:n.emptyObject());if(typeof t==="string")e.path=t;if(typeof i==="string")e.method=i;if(typeof r!=="function")r=n.noop;return[e,a(this._resilient,r)]}function a(t,e){return v(function r(n,i){t.emit("request:finish",n,i,t);e(n,i)})}function c(t,e){var r=t.options("service").get();if(e.timeout){e.$timeout=e.timeout}return n.merge(r,e)}function l(t){return t&&(n.isURI(t.path)||n.isURI(t.url))||false}function p(t,e,r){if(e.path){e.url=e.path;e.path=null}return(t._httpClient||o).call(null,e,r)}function v(t){var e=false;return function(){if(e===false){e=true;t.apply(null,arguments)}}}},{"./http":7,"./resolver":13,"./utils":20}],3:[function(t,e,r){var n=e.exports=Object.create(null);n.service={method:"GET",timeout:10*1e3,timeouts:null,servers:null,retry:0,waitBeforeRetry:50,discoverBeforeRetry:true,promiscuousErrors:false,omitRetryWhen:null,omitFallbackWhen:null,omitRetryOnMethods:null,omitFallbackOnMethods:null,omitRetryOnErrorCodes:null,omitFallbackOnErrorCodes:null};n.balancer={enable:true,roundRobin:true,roundRobinSize:3,weight:{success:15,error:50,latency:35}};n.discovery={servers:null,method:"GET",retry:3,parallel:true,waitBeforeRetry:1e3,timeout:2*1e3,cacheEnabled:true,cacheExpiration:60*15*1e3,promiscuousErrors:true,refreshInterval:60*2*1e3,enableRefreshServers:true,enableSelfRefresh:false,forceRefreshOnStart:true,refreshServersInterval:60*5*1e3,refreshServers:null,refreshOptions:null,refreshPath:null,omitRetryWhen:null,omitFallbackWhen:null,omitRetryOnMethods:null,omitFallbackOnMethods:null,omitRetryOnErrorCodes:null,omitFallbackOnErrorCodes:null};n.resilientOptions=["servers","retry","timeouts","$timeout","parallel","cacheEnabled","cacheExpiration","refreshInterval","refreshServers","refreshOptions","refreshPath","waitBeforeRetry","promiscuousErrors","omitRetryWhen","omitFallbackWhen","omitRetryOnMethods","omitFallbackOnMethods","omitRetryOnErrorCodes","omitFallbackOnErrorCodes","enableRefreshServers","refreshServersInterval","discoverBeforeRetry","enableSelfRefresh","forceRefreshOnStart"]},{}],4:[function(t,e,r){var n=t("./utils");var i=t("./servers");var o=t("./requester");var s=t("./error");var u=3;e.exports=f;function f(t,e,r){var f=o(t);var v=t._middleware;function h(){return n.merge(t.options("discovery").get(),e)}function d(){return r||t.servers("discovery")}function y(){var t=d();return t&&t.exists()||false}function m(e,r){var n=[];var o=d().sort("read",t.balancer());var s=c(o.length);var l=p(r,n);var v=a(o,s,l);o.slice(0,u).forEach(function(t,r){var s=[t];if(r===2&&o.length>u){s=s.concat(o.slice(u))}f(new i(s),e,v,n)(null)})}function g(t,e){if(t.parallel){m(t,e)}else{f(d(),t,p(e))(null)}}function b(t){var e=h();e.params=l(e);v.run("discovery","out")(e,function(r){if(r){t(new s(1007,r))}else{g(e,t)}})}return function O(t){if(y()===false){t(new s(1002))}else{b(t)}}}function a(t,e,r){return function n(t,i){var o=e();if(t==null||o===0){e(true);r(t,i)}}}function c(t){t=t>2?u:t;return function e(r){return t=r?-1:t-1}}function l(t){return n.extend(t.params||t.qs||{},{_time:n.now()})}function p(t,e){return function(r,n){v(e);t(r||null,n)}}function v(t){if(t){if(!y(t)){t.forEach(h)}t.splice(0)}}function h(t){if(t){if(t.xhr){if(t.xhr.readyState!==4){d(t.xhr)}}else{d(t)}}}function d(t){if(typeof t.abort==="function"){try{t.abort()}catch(e){}}}function y(t){return t.filter(function(t){return n.isObj(t)}).length===0}},{"./error":5,"./requester":11,"./servers":18,"./utils":20}],5:[function(t,e,r){e.exports=i;var n={1e3:"All requests failed. No servers available",1001:"Cannot update discovery servers. Empty or invalid response body",1002:"Missing discovery servers. Cannot resolve the server",1003:"Cannot resolve servers. Missing data",1004:"Discovery server response is invalid or empty",1005:"Missing servers during retry process",1006:"Internal unexpected error",1007:"Middleware error"};function i(t,e){if(e instanceof Error){Error.call(this);this.error=e;if(e.code)this.code=e.code;if(e.stack)this.stack=e.stack}else if(e){this.request=e}this.status=t;this.message=n[this.status];if(t===1007&&e){this.message+=": "+(e.message||e)}}i.prototype=Object.create(Error.prototype);i.MESSAGES=n},{}],6:[function(t,e,r){e.exports=n;function n(){this.strategies=[]}n.prototype.add=function(t){if(typeof t==="function"){this.strategies.push(t)}};n.prototype.eval=function(t,e){return this.strategies.some(function(r){return r(t,e)})}},{}],7:[function(t,e,r){var n=t("./utils");var i=typeof window==="object"&&window;var o=/application\/json/i;var s=h();e.exports=u;function u(){return s.apply(null,arguments)}u.VERSION=s.VERSION;u.mapResponse=f;function f(t){return function(e,r,n){if(r&&r.statusCode){r.status=r.statusCode}if(n){(e||r).data=a(e||r)?JSON.parse(n):n}t(e,r)}}function a(t){return typeof t.body==="string"&&o.test(t.headers["content-type"])}function c(t){if(typeof t==="string"){t={url:t}}else{t=t||{}}if(t.params)t.qs=t.params;if(t.data)v(t);if(!i)l(t);return t}function l(t){t.headers=t.headers||{};if(!t.headers["User-Agent"]){t.headers["User-Agent"]=p()}}function p(){return"resilient-http "+u.LIBRARY_VERSION+" (node)"}function v(t){var e=t.data||t.body;if(e&&n.isObj(e)||n.isArr(e)){t.json=true;t.data=null}t.body=e}function h(){if(i){return t("lil-http")}else{return d(t("request"))}}function d(t){return function e(r,n){return t(c(r),f(n))}}},{"./utils":20,"lil-http":23,request:21}],8:[function(t,e,r){var n=t("./http");var i=t("./client");var o=t("./options");var s=t("./defaults");var u=t("./resilient");e.exports=f;function f(t){return new u(t)}f.VERSION="0.3.1";f.CLIENT_VERSION=n.VERSION;f.defaults=s;f.Options=o;f.Client=i;f.request=n;n.LIBRARY_VERSION=f.VERSION;if(typeof window!=="undefined"&&typeof t==="function"){window.resilient=f}},{"./client":2,"./defaults":3,"./http":7,"./options":10,"./resilient":12}],9:[function(t,e,r){var n=t("./utils");var i=t("midware");var o=["in","out"];e.exports=s;function s(){this.pool=u()}s.prototype.use=function(t,e){var r=this.pool;var i=n.toArr(e);i.filter(n.isFn).map(a(t)).forEach(c(r))};s.prototype.run=function(t,e){return this.pool[t][e].run};function u(){return{discovery:f(),service:f()}}function f(){return{"in":i(),out:i()}}function a(t){return function(e){var r=e.type||"service";var n=t.options(r);return{type:r,handler:e(n,t)}}}function c(t){return function(e){var r="in";var i=e.handler;if(n.isFn(i)){if(i.hook==="out"){r="out"}t[e.type][r](i)}if(n.isObj(i)){o.filter(function(t){return n.isFn(i[t])}).forEach(function(r){t[e.type][r](i[r])})}}}},{"./utils":20,midware:24}],10:[function(t,e,r){var n=t("./utils");var i=t("./defaults");var o=t("./servers");e.exports=s;function s(t,e){this.store=e?n.clone(i[e]):Object.create(null);this.set(t)}s.prototype.get=function(t){return t?this.store[t]:n.clone(this.store)};s.prototype.http=function(){return n.omit(this.store,i.resilientOptions)};s.prototype.clone=function(){return s.define(u(this.store))};s.prototype.servers=function(t){return t?this.setServers(t):this.store.servers};s.prototype.setServers=function(t){if(this.store.servers){this.store.servers.set(t)}else{this.store.servers=new o(t)}};s.prototype.set=function(t,e){if(n.isObj(t)){n.each(t,n.bind(this,this.set))}else if(e!==undefined){if(t==="servers"){this.setServers(e)}else{if(t==="refreshServers"){e=new o(e)}this.store[t]=e}}};s.define=function(t,e){var r=new s;var n=t||{};Object.keys(e||i).filter(function(t){return t!=="resilientOptions"}).forEach(function(t){r.set(t,new s(n[t],t))});return r};function u(t){var e={};n.each(t,function(t,r){if(r instanceof s){e[t]=r.get()}});return e}},{"./defaults":3,"./servers":18,"./utils":20}],11:[function(t,e,r){var n=t("./utils");var i=t("./http");var o=t("./error");var s=t("./defaults").resilientOptions;e.exports=u;function u(t){return function e(r,i,o,s){var u=M(i.method);var c=f(t,r,u);i=n.clone(i);return function l(e){var n,f=c.shift();if(f){i=m(f,i);n=v(f,u,i,y(o),l,t);d(t,i,n,s)}else{a(t,r,i,e,o)}}}}function f(t,e,r){if(t.balancer().get("enable")){return e.sort(r,t.balancer())}else{return e.get()}}function a(t,e,r,n,i){var s=n();var u=b(s);if(w(r,u)){i.apply(null,s)}else if(r.retry){c(t,e,r,i)}else{i(new o(1e3,u))}}function c(t,e,r,n){var i=p(t,e,r,n);var o=l(i,r);if(r.discoverBeforeRetry){O(t,o)}else{o()}}function l(t,e){return function(){n.delay(t,e.retryWait)}}function p(t,e,r,n){return function(){if(e.exists()){r.retry-=1;t.emit("request:retry",r,e);u(t)(e,r,n)()}else{n(new o(1005))}}}function v(t,e,r,i,o,s){var u=n.now();return function f(a,c){var l=n.now()-u;s.emit("request:incoming",a,c,r,s);if(S(r,a||c)){t.reportError(e,l);i(a,c)}else if(T(s,r,a,c)){t.reportError(e,l);s.emit("request:fallback",r,a||c);o(h(a,c))}else{t.report(e,l);i(a,c)}}}function h(t,e){return function(r){return[t,e]}}function d(t,e,r,i){t.emit("request:outgoing",e,t);try{var o=P(t)(n.omit(e,s),r);if(i)i.push(o)}catch(u){r(u)}}function y(t){var e=i.mapResponse(t);return function(t,r){var n=t||r;var i=n?n.body||n.data:null;e(t,r,i)}}function m(t,e){e.url=n.join(t.url,e.basePath,e.path);e.timeout=g(e);return e}function g(t){var e=t.$timeout||t.timeout;var r=t.timeouts;var i=t.method;if(!t.$timeout&&n.isObj(r)){e=r[i]||r[i.toLowerCase()]||e}return e}function b(t){return t.filter(function(t){return t!=null}).pop()}function O(t,e){if(t.hasDiscoveryServers()){t._sync.unlock("updating");u.DiscoveryResolver.update(t,null,e)}else{e()}}function w(t,e){return A(t.omitRetryOnErrorCodes,e?e.status:null)||_(t.omitRetryOnMethods,t.method)||R(t.omitRetryWhen,t.method,e)}function S(t,e){return q(t,e)||E(t)||R(t.omitFallbackWhen,t.method,e)}function E(t){var e=t.omitFallbackOnMethods;return _(e,t.method)}function R(t,e,r){return n.isArr(t)&&r&&r.status&&t.some(x(e,r))}function x(t,e){return function(r){return n.isObj(r)&&j(r,t)&&C(r,e.status)}}function j(t,e){return t.method&&t.method===e||n.isArr(t.methods)&&k(t.methods,e)}function C(t,e){return e&&(t.code&&t.code===e||n.isArr(t.codes)&&A(t.codes,e))}function q(t,e){var r=t.omitFallbackOnErrorCodes;return e&&A(r,e.status)}function _(t,e){return n.isArr(t)&&t.length&&k(t,e)}function A(t,e){return e&&n.isArr(t)&&t.length&&~t.indexOf(e)&&e>=300}function k(t,e){e=(e||"GET").toUpperCase();return t.filter(function(t){return typeof t==="string"}).map(function(t){return t.toUpperCase().trim()}).some(function(t){return t===e})}function T(t,e,r,n){return I(r,n)||t._failStrategies.eval(r,n)||e.promiscuousErrors&&F(r||n)}function I(t,e){return t&&(t.code!==undefined||t.status===undefined&&e==undefined)||U(t||e)||false}function U(t){return N(429,t)}function F(t){return N(400,t)}function N(t,e){return e&&!e.code&&(e.status>=t||e.status===0)||false}function M(t){return t.toUpperCase()==="GET"?"read":"write"}function P(t){return typeof t._httpClient==="function"?t._httpClient:i}},{"./defaults":3,"./error":5,"./http":7,"./utils":20}],12:[function(t,e,r){var n=t("lil-event");var i=t("./utils");var o=t("./sync");var s=t("./cache");var u=t("./client");var f=t("./options");var a=t("./middleware");var c=t("./evaluator");var l=t("./resolvers/discovery");e.exports=p;function p(t){this.cache=new s;this._sync=new o;this._client=new u(this);this._middleware=new a;this._failStrategies=new c;this._options=f.define(t)}p.prototype=Object.create(n.prototype);p.prototype.servers=function(t){var e=this.options(t||"service");return e?e.servers():null};p.prototype.setServers=function(t,e){this.options(e||"service").servers(t);return this};p.prototype.serversURL=function(t){var e=this.servers(t);return e?e.urls():null};p.prototype.discoveryServers=function(t){if(i.isArr(t)){this.options("discovery").servers(t)}else{return this.servers("discovery")}};p.prototype.hasDiscoveryServers=function(){var t=this.discoveryServers();return i.isObj(t)&&t.exists()||false};p.prototype.resetScore=p.prototype.resetStats=function(t){var e=this.options(t||"service").servers();if(e){e.resetStats()}return this};p.prototype.latestServers=p.prototype.getUpdatedServers=function(t,e){e=typeof t==="function"?t:e;if(this.discoveryServers()){this.discoverServers(t,e)}else if(this.servers("service")){e(null,this.servers("service").urls())}else{e(new Error("Missing servers"))}return this};p.prototype.discoverServers=function(t,e){return v(this,"fetch",t,e)};p.prototype.updateServers=function(t,e){return v(this,"update",t,e)};function v(t,e,r,n){if(typeof r==="function"){n=r;r=null}l[e](t,r,n||i.noop);return t}p.prototype.options=function(t,e){if(t&&i.isObj(e)){var r=this._options.get(t);if(r instanceof f){r.set(e)}return}if(i.isObj(t)){this._options=f.define(t);return}return this._options.get(t)};p.prototype.discoveryOptions=function(t){if(t){this.options("discovery",t)}else{return this.options("discovery").get()}};p.prototype.serviceOptions=function(t){if(t){this.options("service",t)}else{return this.options("service").get()}};p.prototype.httpOptions=function(t){var e=this.options(t||"service");if(e)return e.http()};p.prototype.useHttpClient=function(t){if(typeof t==="function"){this._httpClient=t}return this};p.prototype.restoreHttpClient=function(){this._httpClient=null;return this};p.prototype.serversUpdated=function(){var t=this.servers().lastUpdate();var e=this.options("discovery").get("refreshInterval")||0;return t<e};p.prototype.balancer=function(t){if(t){this.options("balancer",t)}else{return this.options("balancer")}};p.prototype.send=p.prototype.request=function(t,e,r){return this._client.send(t,e,r)};p.prototype.mock=function(t){this.useHttpClient(function(e,r){i.delay(function(){t(e,r)})});return this};p.prototype.unmock=function(){this.restoreHttpClient();return this};p.prototype.use=function(){this._middleware.use(this,arguments);return this};p.prototype.http=p.prototype.client=function(){return this._client};p.prototype.failStrategy=p.prototype.addFailStrategy=function(t){this._failStrategies.add(t);return this};["get","post","put","del","delete","head","patch"].forEach(function h(t){p.prototype[t]=function(e,r,n){return this._client[t](e,r,n)}})},{"./cache":1,"./client":2,"./evaluator":6,"./middleware":9,"./options":10,"./resolvers/discovery":14,"./sync":19,"./utils":20,"lil-event":22}],13:[function(t,e,r){var n=t("./utils");var i=t("./servers");var o=t("./requester");var s=t("./error");var u=t("./discovery");var f=t("./resolvers/discovery");e.exports=a;function a(t,e,r){var n=t._sync;var a=t._middleware;r=j(r);try{h(R)}catch(v){r(new s(1006,v))}function h(t){if(O()){d(t)}else if(S()){t()}else if(w()){b(t)}else{t(new s(1002))}}function d(e){var r=m();var i=l(r);var o=p(r);if(n.locked("discovering")){n.enqueue("discovering",y(r,e))}else{n.lock("discovering");u(t,o,i)(y(r,e))}}function y(t,e){return function(r,i){n.unlock("discovering");n.dequeue("discovering").forEach(function(t){t(r,i)});a.run("discovery","in")(r,i,function(n){if(r||n){e(new s(r?1001:1007,r||n))}else if(i&&i.data){g(i.data,t);b(e)}else{e(new s(1004,r))}})}}function m(){return t.options("discovery")}function g(e,r){t.emit("discovery:refresh",e,t);r.servers(e)}function b(e){f.update(t,null,e)}function O(){var t=false;var e=m();var r=e.get("servers");if(c(e)){if(r&&r.exists()){if(e.get("forceRefreshOnStart")){t=r.updated===0}if(!t){t=r.lastUpdate()>e.get("refreshServersInterval")}}else{t=true}}return t}function w(){return t.hasDiscoveryServers()}function S(){var e=t.servers();return e&&e.exists()&&E(e)||false}function E(t){var e=m().get("refreshInterval");if(w()){return t.lastUpdate()<e}return true}function R(t,e){t?r(t):x(e)}function x(n){var u=t.servers();var f=o(t);if(n&&n._cache){u=new i(n.data)}else if(!S()){return r(new s(1003))}a.run("service","out")(u,e,function(t){if(t){r(new s(1007,t))}else{f(u,e,r)(null)}})}function j(t){return function(e,r){a.run("service","in")(e,r,function(n){if(e||n){t(e?e:new s(1007,n))}else{t(null,r)}})}}}function c(t){var e=t.get("refreshServers");return t.get("enableRefreshServers")&&(t.get("enableSelfRefresh")||e&&e.exists())}function l(t){var e="refreshServers";if(t.get("enableSelfRefresh")){e="servers"}return t.get(e)}function p(t){var e=n.omit(t.get(),["servers","refreshOptions"]);var r=n.merge(e,t.get("refreshOptions"),{discoverBeforeRetry:false});var i=v(t.get());if(i)r.basePath=i;return r}function v(t){return t&&(t.refreshPath||n.isObj(t.refreshOptions)&&t.refreshOptions.basePath)||false}},{"./discovery":4,"./error":5,"./requester":11,"./resolvers/discovery":14,"./servers":18,"./utils":20}],14:[function(t,e,r){var n=t("../error");var i=t("../requester");var o=t("../discovery");var s=t("./service");e.exports=u;i.DiscoveryResolver=u;function u(t,e,r){var n=t._sync;function i(t){return function(e,r){n.unlock("updating");n.dequeue("updating").forEach(function(t){t(e,r)});t(e,r)}}function s(s){n.lock("updating");o(t,e,r)(i(s))}return function u(t){if(n.locked("updating")){n.enqueue("updating",t)}else{s(t)}}}u.update=function(t,e,r){u(t,e)(s(t)(r))};u.fetch=function(t,e,r){u(t,e)(f(r))};function f(t){return function(e,r){if(e){t(e)}else if(r&&r.data){t(null,r.data)}else{t(new n(1001,r))}}}},{"../discovery":4,"../error":5,"../requester":11,"./service":15}],15:[function(t,e,r){var n=t("../utils");var i=t("../error");e.exports=o;function o(t){var e=t._middleware;var r=t.options("discovery");function o(){return r.get("cacheEnabled")}function u(){return t.cache.get("servers")}function a(e,r){t.emit("servers:"+e,r,t)}function c(e,r){var n=e.data;a("refresh",n);t.setServers(n);h(n);r(null,e)}function l(t,e){if(o()){p(t,e)}else{f(t,e)}}function p(t,e){var r=u();if(v(r)){e(null,{status:200,_cache:true,data:r.data})}else{f(t,e)}}function v(t){var e=r.get("cacheExpiration");return t&&n.isArr(t.data)&&n.now()-t.time>e||false}function h(e){if(o()){a("cache",e);t.cache.set("servers",e)}}function d(t,e,r){if(t){l(t,r)}else if(s(e)){c(e,r)}else{r(new i(1004,e))}}return function y(t){return function r(n,i){e.run("discovery","in")(n,i,function(e){d(n||e,i,t)})}}}function s(t){var e=false;if(t){if(n.isArr(t.data)&&t.data.length){e=true}else if(typeof t.data==="string"){e=u(t)}}return e}function u(t){try{t.data=JSON.parse(t.data);return true}catch(e){return false}}function f(t,e){t=t||{status:1e3};return e(new i(t.status,t))}},{"../error":5,"../utils":20}],16:[function(t,e,r){e.exports=n;function n(t,e){e=+e<2?2:e;return i(e,t)[o(e)].shift()}function i(t,e){var r,n,i,o=[];if(!e){e=[];for(r=1;r<=t;r+=1)e.push(r)}else{e=e.slice()}if(t%2===1){e.push(-1);t+=1}for(n=0;n<t-1;n+=1){o[n]=[];for(i=0;i<t/2;i+=1){if(e[i]!==-1&&e[t-1-i]!==-1){o[n].push([e[i],e[t-1-i]])}}e.splice(1,0,e.pop())}return o}function o(t){t=t>0?t-1:t;return Math.round(Math.random()*(t-0)+0)}},{}],17:[function(t,e,r){var n=t("./defaults").balancer;e.exports=i;function i(t){this.url=t;this.resetStats()}i.prototype.report=function(t,e,r){var n=this.stats(t);if(n){n[r||"request"]+=1;n.latency=f(e||0,n)}};i.prototype.reportError=function(t,e){this.report(t,e,"error")};i.prototype.balance=function(t,e){var r=this.stats(t);var i=n.weight;var o=r.request+r.error;return!!o?u(r,i,o):0};i.prototype.stats=function(t,e){var r=this.statsStore[t||"read"];if(r&&e)r=r[e];return r};i.prototype.resetStats=function(){this.statsStore=o()};function o(){return{read:s(),write:s()}}function s(){return{latency:0,error:0,request:0}}function u(t,e,r){return a((t.request*100/r*e.success+t.error*100/r*e.error+t.latency*e.latency)/100)}function f(t,e){return a((t+e.latency)/(e.request+e.error))}function a(t){return+(t*100/100).toFixed(2)}},{"./defaults":3}],18:[function(t,e,r){var n=t("./utils");var i=t("./server");var o=t("./roundrobin");e.exports=s;function s(t){this.servers=[];this.updated=0;this.set(t)}s.prototype.get=function(){return this.servers.slice(0)};s.prototype.set=function(t){if(n.isArr(t)){this.updated=n.now();this.servers=f.call(this,t)}};s.prototype.lastUpdate=function(){return n.now()-this.updated};s.prototype.empty=function(){return this.servers.length===0};s.prototype.exists=function(){return this.size()>0};s.prototype.size=function(){return this.servers.length};s.prototype.urls=function(){return this.servers.map(function(t){return t.url})};s.prototype.resetStats=function(){this.servers.forEach(function(t){t.resetStats()})};s.prototype.sort=function(t,e){var r=this.servers.slice(0);if(r.length>1){r.sort(function(r,n){return r.balance(t,e)-n.balance(t,e)});r=c(r,e)}return r};s.prototype.find=function(t){var e,r,n=null;for(e=0,r=this.servers.length;e<r;e+=1){if(this.servers[e].url===t){n=this.servers[e];break}}return n};function u(t){if(n.isObj(t))t=t.url||t.uri;return n.isURI(t)}function f(t){return t.filter(u).map(n.bind(this,a))}function a(t){var e;if(t instanceof i){e=t}else{e=this.find(n.isObj(t)?t.url:t);if(!e)e=new i(t)}return e}function c(t,e){var r=0;if(e&&e.roundRobin){r=e.roundRobinSize>t.length?t.length:e.roundRobinSize;if(r>1)t=o(t,r)}return t}},{"./roundrobin":16,"./server":17,"./utils":20}],19:[function(t,e,r){var n=t("./utils").isArr;e.exports=i;function i(){this.locks={};this.queues={}}i.prototype.locked=function(t){return o(this.locks,t)};i.prototype.lock=function(t){return this.locks[t]=true};i.prototype.unlock=function(t){return this.locks[t]=false};i.prototype.enqueue=function(t,e){if(o(this.locks,t)){this.push(t,e)}};i.prototype.dequeue=function(t){return(this.queues[t]||[]).splice(0)};i.prototype.push=function(t,e){var r=this.queues[t];if(n(r)===false){r=this.queues[t]=[]}r.push(e)};function o(t,e){var r=t[e];if(r===undefined){r=t[e]=false}return r}},{"./utils":20}],20:[function(t,e,r){var n=r;var i=Object.prototype.toString;var o=Array.prototype.slice;var s=Object.prototype.hasOwnProperty;var u=Function.prototype.bind;var f=Array.isArray;var a=/^http[s]?\:\/\/(.+)/i;r.noop=function(){};r.now=function(){return(new Date).getTime()};r.emptyObject=function(){return Object.create(null)};r.isObj=function(t){return t&&i.call(t)==="[object Object]"||false};r.isArr=function(t){return t&&f?f(t):i.call(t)==="[object Array]"};r.isFn=function(t){return typeof t==="function"};r.bind=function(t,e){return u?e.bind(t):function(){return e.apply(t,arguments)}};r.each=function(t,e){var r,i;if(n.isArr(t))for(r=0,i=t.length;r<i;r+=1)e(t[r],r);else if(n.isObj(t))for(r in t)if(s.call(t,r))e(r,t[r])};r.clone=function(t){return n.extend({},t)};r.omit=function(t,e){var r,i={};if(n.isObj(t)){for(r in t)if(s.call(t,r)){if(e.indexOf(r)===-1)i[r]=t[r]}}return i};r.delay=function(t,e){return setTimeout(t,e||1)};r.isURI=function(t){return typeof t==="string"&&a.test(t)};r.join=function(t){return(t||"")+n.toArr(arguments,1).filter(c).join("")};function c(t){return typeof t==="string"&&t.length>0}r.toArr=function(t,e){return o.call(t,+e||0)};r.extend=p(l);r.merge=p(h);function l(t,e,r){t[e]=r}function p(t){return function(e){var r=n.toArr(arguments,1);n.each(r,v(e,t));return e}}function v(t,e){return function(r){if(n.isObj(r)){n.each(r,function(r,n){e(t,r,n)})}}}function h(t,e,r){if(n.isObj(r)&&n.isObj(t[e])){n.merge(t[e],r)}else{l(t,e,r)}}},{}],21:[function(t,e,r){},{}],22:[function(e,r,n){(function(e,i){if(typeof t==="function"&&t.amd){t(["exports"],i)}else if(typeof n==="object"){i(n);if(typeof r==="object"&&r!==null){r.exports=n.Event}}else{i(e.lil=e.lil||{})}})(this,function(t){"use strict";var e="0.1.3";var r=Array.prototype.slice;var n=Object.prototype.hasOwnProperty;function i(){}i.prototype.constructor=i;i.prototype.addListener=i.prototype.on=function(t,e,r){if(typeof t!=="string")throw new TypeError("First argument must be a string");if(typeof e!=="function")throw new TypeError("Second argument must be a function");if(!o.call(this,t,e)){s.call(this,t).push({fn:e,once:r||false})}return this};i.prototype.removeListener=i.prototype.off=function(t,e){var r;var n=s.call(this,t);var i=o.call(this,t,e);if(i){r=n.indexOf(i);if(r>=0)n.splice(r,1)}return this};i.prototype.addOnceListener=i.prototype.once=function(t,e,r){this.addListener(t,e,true);return this};i.prototype.emit=i.prototype.fire=function(t){var e,n,i,o=r.call(arguments).slice(1);var u=s.call(this,t);if(t){for(e=0,n=u.length;e<n;e+=1){i=u[e];if(i.once)u.splice(e,1);i.fn.apply(null,o)}}return this};i.prototype.removeAllListeners=i.prototype.offAll=function(t){if(t&&n.call(this._events,t)){this._events[t].splice(0)}return this};function o(t,e){var r,n,i,o=s.call(this,t);for(r=0,n=o.length;r<n;r+=1){i=o[r];if(i.fn===e)return i}}function s(t,e){var r=u.call(this);return n.call(r,t)?r[t]:r[t]=[]}function u(){return this._events||(this._events={})}i.VERSION=e;t.Event=i})},{}],23:[function(e,r,n){(function(e,i){if(typeof t==="function"&&t.amd){t(["exports"],i)}else if(typeof n==="object"){i(n);if(typeof r==="object"&&r!==null){r.exports=n=n.http}}else{i(e.lil=e.lil||{})}})(this,function(t){"use strict";var e="0.1.16";var r=Object.prototype.toString;var n=Array.prototype.slice;var i=Object.prototype.hasOwnProperty;var o=typeof Function.prototype.bind==="function";var s=location.origin;var u=/^(http[s]?:\/\/[a-z0-9\-\.\:]+)[\/]?/i;var f=/application\/json/;var a=typeof XDomainRequest!=="undefined";var c=function(){};var l={method:"GET",timeout:30*1e3,auth:null,data:null,headers:null,withCredentials:false,responseType:"text"};function p(t){return t&&r.call(t)==="[object Object]"||false}function v(t){var e,r,o,s,u=n.call(arguments).slice(1);for(e=0,r=u.length;e<r;e+=1){s=u[e];for(o in s)if(i.call(s,o))t[o]=s[o]}return t}function h(t){var e=false;return function(){if(e===false){e=true;t.apply(null,arguments)}}}function d(t,e){if(p(e)){e["Content-Type"]=e["Content-Type"]||M.defaultContent;for(var r in e)if(i.call(e,r)){t.setRequestHeader(r,e[r])}}}function y(t){var e={},r=t.getAllResponseHeaders().trim().split("\n");r.forEach(function(t){var r=t.trim().split(":");var n=r.shift().trim();var i=r.join(":").trim();e[n]=i});return e}function m(t){return f.test(t.getResponseHeader("Content-Type"))}function g(t){return Object.getOwnPropertyNames(t).filter(function(e){return t[e]!==undefined}).map(function(e){var r=t[e]===null?"":t[e];return encodeURIComponent(e)+(r?"="+encodeURIComponent(r):"")}).join("&").replace(/%20/g,"+")}function b(t){var e=null;if(t.responseType==="text"){e=t.responseText;if(m(t)&&e)e=JSON.parse(e)}else{e=t.response}return e}function O(t){return t===1223?204:t}function w(t){var e={xhr:t,status:O(t.status),statusText:t.statusText,data:null,headers:{}};if(t.readyState===4){e.data=b(t);e.headers=y(t)}return e}function S(t,e){var r=w(t);r.error=e;if(e.stack)r.stack=e.stack;return r}function E(t){t.onreadystatechange=t.onerror=t.ontimeout=null}function R(t){var e=O(t.status);return e>=200&&e<300||e===304}function x(t,e){return h(function(r){e(S(t,r),null)})}function j(t,e,r){return function(t){if(e.readyState===4){E(e);if(R(e)){r(null,w(e))}else{x(e,r)(t)}}}}function C(t){var e=t.match(u);return e&&e[1]===s}function q(t){var e=t.url;if(p(t.params)){e+=(e.indexOf("?")===-1?"?":"&")+g(t.params)}return e}function _(t){if(a&&C(t)){return new XDomainRequest}else{return new XMLHttpRequest}}function A(t){var e=(t.method||"GET").toUpperCase();var r=t.auth;var n=q(t);var i=_(n);if(r){i.open(e,n,true,r.user,r.password)}else{i.open(e,n)}i.withCredentials=t.withCredentials;i.responseType=t.responseType;i.timeout=t.timeout;d(i,t.headers);return i}function k(t,e){return function(t){if(t.lengthComputable){e(t,t.loaded/t.total)}else{e(t)}}}function T(t){return t&&p(t.headers)&&(t.headers["content-type"]||t.headers["Content-Type"])||false}function I(t,e){var r=e.data;if(p(e.data)||Array.isArray(e.data)){if(T(e)===false){t.setRequestHeader("Content-Type","application/json")}r=JSON.stringify(e.data)}return r}function U(t,e){return function(){clearTimeout(e);t.apply(null,arguments)}}function F(t,e,r){var n=A(t);var i=I(n,t);var s=x(n,e);if(o){n.ontimeout=s}else{var u=setTimeout(function a(){if(n.readyState!==4){n.abort()}},t.timeout);e=U(e,u);s=x(n,e)}n.onreadystatechange=j(t,n,e);n.onerror=s;if(typeof r==="function"){n.onprogress=k(n,r)}try{n.send(i||null)}catch(f){s(f)}return{xhr:n,config:t}}function N(t){return function(e,r,i,o){var s,u,f=null;var a=v({},l,{method:t});var h=n.call(arguments);for(s=0,u=h.length;s<u;s+=1){f=h[s];if(typeof f==="function"){if(h.length===s+1&&typeof h[s-1]==="function"){o=f}else{i=f}}else if(p(f)){v(a,f)}else if(typeof f==="string"&&!a.url){a.url=f}}return F(a,i||c,o)}}function M(t,e,r,n){return N("GET").apply(null,arguments)}M.VERSION=e;M.defaults=l;M.defaultContent="text/plain";M.get=N("GET");M.post=N("POST");M.put=N("PUT");M.patch=N("PATCH");M.head=N("HEAD");M.delete=M.del=N("DELETE");return t.http=M})},{}],24:[function(e,r,n){(function(e,i){if(typeof t==="function"&&t.amd){t(["exports"],i)}else if(typeof n==="object"){i(n);if(typeof r==="object"&&r!==null){r.exports=n=n.midware}}else{i(e)}})(this,function(t){"use strict";var e=Array.prototype.slice;function r(t){var r=[];t=t||null;function n(){var n=e.call(arguments);n.filter(function(t){return typeof t==="function"}).forEach(function(t){r.push(t)});return t}n.run=function i(){var n;var i=e.call(arguments);var o=r.slice();if(typeof i[i.length-1]==="function"){n=i.pop()}if(!o.length){if(n)n.call(t);return}i.push(u);function s(){o.shift().apply(t,i)}function u(e,r){if(e||r||!o.length){o=null;if(n){n.call(t,e)}return}s()}s()};return n}t.midware=r})},{}]},{},[8])(8)});
//# sourceMappingURL=http://cdn.rawgit.com/resilient-http/resilient.js/0.3.0/resilient.min.js.map