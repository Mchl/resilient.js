/*! resilient - v0.1 - MIT License - https://github.com/resilient-http/resilient.js */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.resilient=t()}}(function(){var t,e,r;return function n(t,e,r){function i(s,u){if(!e[s]){if(!t[s]){var a=typeof require=="function"&&require;if(!u&&a)return a(s,!0);if(o)return o(s,!0);var f=new Error("Cannot find module '"+s+"'");throw f.code="MODULE_NOT_FOUND",f}var c=e[s]={exports:{}};t[s][0].call(c.exports,function(e){var r=t[s][1][e];return i(r?r:e)},c,c.exports,n,t,e,r)}return e[s].exports}var o=typeof require=="function"&&require;for(var s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,r,n){(function(e,i){if(typeof t==="function"&&t.amd){t(["exports"],i)}else if(typeof n==="object"){i(n);if(typeof r==="object"&&r!==null){r.exports=n=n.http}}else{i(e.lil=e.lil||{})}})(this,function(t){"use strict";var e="0.1.7";var r=Object.prototype.toString;var n=Array.prototype.slice;var i=Object.prototype.hasOwnProperty;var o=location.origin;var s=/^(http[s]?:\/\/[a-z0-9\-\.\:]+)[\/]?/i;var u=typeof XDomainRequest!=="undefined";var a={method:"GET",timeout:30*1e3,auth:null,headers:null,async:true,withCredentials:false,responseType:"text"};function f(t){return t&&r.call(t)==="[object Object]"}function c(t){return t&&r.call(t)==="[object Array]"}function l(t){var e,r,o,s,u=n.call(arguments).slice(1);for(e=0,r=u.length;e<r;e+=1){s=u[e];for(o in s)if(i.call(s,o))t[o]=s[o]}return t}function p(t,e){if(f(e)){e["Content-Type"]=e["Content-Type"]||j.defaultContent;for(var r in e){t.setRequestHeader(r,e[r])}}}function h(t){var e={},r=t.getAllResponseHeaders().split("\n");r.forEach(function(t){if(t){t=t.split(":");e[t[0].trim()]=(t[1]||"").trim()}});return e}function v(t){var e,r=t.getResponseHeader("Content-Type");if(t.responseType==="text"){e=t.responseText;if(r==="application/json"&&e)e=JSON.parse(e)}else{e=t.response}return e}function d(t){return{xhr:t,status:t.status,data:v(t),headers:h(t)}}function y(t,e){var r=new Error(e.message);l(r,d(t));r.error=e;r.stack=e.stack;return r}function g(t,e){var r=false;return function(n){if(!r){e(y(t,n),null);r=true}}}function b(t,e){return function(){if(t.readyState===4){if(t.status>=200&&t.status<400){e(null,d(t))}else{e(d(t),null)}}}}function w(t){var e=t.match(s);return e&&e[1]===o}function O(t){var e=null;var r=(t.method||"GET").toUpperCase();var n=t.auth||{};var i=t.url;if(u&&w(i)){e=new XDomainRequest}else{e=new XMLHttpRequest}e.open(r,i,t.async,n.user,n.password);e.withCredentials=t.withCredentials;e.responseType=t.responseType;e.timeout=t.timeout;p(e,t.headers);return e}function m(t,e){return function(t){if(evt.lengthComputable){e(t,evt.loaded/evt.total)}else{e(t)}}}function x(t,e,r){var n=O(t);var i=f(t.data)||c(t.data)?JSON.stringify(t.data):t.data;var o=g(n,e);n.onload=b(n,e);n.onerror=o;n.ontimeout=o;n.onabort=o;if(typeof r==="function")n.onprogress=m(n,r);try{n.send(i)}catch(s){o(s)}return{xhr:n,config:t}}function E(t){return function(e,r,i,o){var s,u,c=null;var p=l({},a,{method:t});var h=n.call(arguments);for(s=0,u=h.length;s<u;s+=1){c=h[s];if(typeof c==="function"){i=c;if(i!==c)o=c}else if(f(c)){l(p,c)}else if(typeof c==="string"&&!p.url){p.url=c}}if(typeof i!=="function")throw new TypeError("callback function argument is required");return x(p,i,o)}}function j(t,e,r,n){return E("GET").apply(null,arguments)}j.VERSION=e;j.defaults=a;j.defaultContent="text/plain";j.get=E("GET");j.post=E("POST");j.put=E("PUT");j.del=E("DELETE");j.patch=E("PATCH");j.head=E("HEAD");return t.http=j})},{}],2:[function(t,e,r){var n=t("./utils");var i=t("./requester");e.exports=o;function o(t){this._resilient=t}o.prototype.send=function(t,e,r,n){var o=s.call(this,t,e,r,n);return i.apply(null,[this._resilient].concat(o))};o.prototype.get=function(t,e,r){return this.send(t,e,r,"GET")};o.prototype.post=function(t,e,r){return this.send(t,e,r,"POST")};o.prototype.put=function(t,e,r){return this.send(t,e,r,"PUT")};o.prototype.del=function(t,e,r){return this.send(t,e,r,"DELETE")};o.prototype.patch=function(t,e,r){return this.send(t,e,r,"PATCH")};o.prototype.head=function(t,e,r){return this.send(t,e,r,"HEAD")};function s(t,e,r,i){if(typeof e==="function"){r=e;e=arguments[1]}e=n.extend(u.call(this),e);if(typeof t==="string")e.path=t;if(typeof i==="string")e.method=i;return[e,r]}function u(){return this._resilient.options.get("service").http()}},{"./requester":8,"./utils":12}],3:[function(t,e,r){var n=e.exports={};n.service={method:"GET",timeout:2*1e3,servers:null,cache:true,refresh:60*1e3,cacheExpiration:60*10*1e3};n.balancer={enable:true,roundRobin:false,weight:{request:25,error:50,latency:25}};n.discovery={servers:null,method:"GET",cache:true,retry:0,retryWait:1e3,timeout:2*1e3,parallel:false,cacheExpiration:60*10*1e3};n.resilientOptions=["servers","retry","retryWait","parallel","cacheExpiration","cache"]},{}],4:[function(t,e,r){e.exports=i;var n={1e3:"All requests failed. No servers available",1001:"Cannot update discovery servers. Empty or invalid response body",1002:"Missing discovery servers. Cannot resolve the server",1003:"The server list is empty",1004:"Discovery server response is invalid or empty",1005:"Missing discovery servers during retry process"};function i(t,e){if(e instanceof Error){Error.call(this,e);this.error=e;this.code=e.code}else if(e){this.request=e}this.status=t||1e3;this.message=n[this.status]}i.prototype=Object.create(Error.prototype);i.MESSAGES=n},{}],5:[function(t,e,r){var n=o();e.exports=i;function i(){return n.apply(null,arguments)}function o(){if(typeof window==="object"){return t("../bower_components/lil-http/http")}else{return s(t("request"))}}function s(t){return function(e,r){if(e&&e.data){e.body=e.data}return t.call(null,e,u(r))}}function u(t){return function(e,r,n){if(r){r.status=r.statusCode;if(n){r.data=a(r)?JSON.parse(n):n}}t(e,r)}}function a(t){return t.headers["content-type"]==="application/json"}},{"../bower_components/lil-http/http":1,request:13}],6:[function(t,e,r){var n=t("./resilient");var i=t("./client");var o=t("./options");var s=t("./defaults");e.exports=u;function u(t){return new n(t)}n.VERSION="0.1.0";n.defaults=s;n.Client=i;n.Resilient=n;n.Options=o},{"./client":2,"./defaults":3,"./options":7,"./resilient":9}],7:[function(t,e,r){var n=t("./utils");var i=t("./defaults");var o=t("./servers");e.exports=s;function s(t,e){this.store=e?n.clone(i[e]):{};this.set(t)}s.prototype.get=function(t){var e=null;if(t)e=this.store[t];else e=n.clone(this.store);return e};s.prototype.getRaw=function(){var t={},e=this.get();if(e){n.each(e,function(e,r){if(r instanceof s){t[e]=r.get()}})}return t};s.prototype.set=function(t,e){if(n.isObj(t)){n.each(t,n.bind(this,this.set))}else if(e!==undefined){if(t==="servers"){this.store[t]=new o(e)}else{this.store[t]=e}}};s.prototype.http=function(){return n.omit(this.store,i.resilientOptions)};s.prototype.servers=function(t){return t?this.set("servers",t):this.store.servers};s.prototype.clone=function(){return s.define(this.getRaw())};s.define=function(t,e){var r=new s;t=n.isObj(t)?t:{};e=n.clone(e||i);Object.keys(e).forEach(function(e){if(e!=="resilientOptions"){r.set(e,new s(t[e],e))}});return r}},{"./defaults":3,"./servers":11,"./utils":12}],8:[function(t,e,r){var n=t("./utils");var i=t("./http");var o=t("./error");var s=t("./servers");e.exports=u;function u(t,e,r){w(u);function u(t){if(t){r(t)}else if(!b()){r(new o(1003))}else{v(g(),c(e),r)}}function c(e){var r=t.options.get("service").http();return n.extend(r,e)}function p(t,e){var r=y("discovery").get();if(r.retry){delay(h(servers,r,e),r.retryWait)}else{e(new o(1e3,t))}}function h(e,r,i){return function(){t._updating=false;if(b("discovery")){r=n.extend({},r,{retry:r.retry-1});v(e,r,i)}else{i(new o(1005))}}}function v(t,e,r,o){var s=a(e.method);var t=n.isArr(t)?t:t.sort(s);var u=null;e=n.clone(e);function f(a){var c,l=t.shift();if(l){c=d(l,s,r,f);e.url=n.join(l.url,e.basePath,e.path);try{u=i(e,c);if(o)o.push(u)}catch(h){c(h)}}else{p(a,r)}}f()}function d(t,e,r,i){var o=n.now();return function(s,u){var a=n.now()-o;if(f(s,u)){t.report(e,"error",a);i(s)}else{t.report(e,"request",a);r(null,u)}}}function y(e){return t.options.get(e||"service")}function g(t){return y(t).servers()}function b(t){var e,r=false;e=g(t);if(e&&e.exists()){if(t!=="discovery"){r=e.lastUpdate()<(y(t).get("refresh")||0)}else{r=true}}return r}function w(t){if(b()){t()}else{if(b("discovery")){m(t)}else{t(new o(1002))}}}function O(t,e){var r=[],n=y("discovery").servers().sort();n.slice(0,3).forEach(function(e,o){e=[e];if(o===2&&n.length>3){e=e.concat(n.slice(3))}v(new s(e),t,i,r)});function i(t,n){if(t&&t.request){r.splice(r.indexOf(t.request),1)}else{x(e,r)(t,n)}}}function m(e){var r=y("discovery").get();if(t._updating){t._queue.push(e)}else{r.path=l(r.path);if(r.parallel){O(r,e)}else{t._updating=true;v(g("discovery"),r,x(e))}}}function x(e,r){return function(n,i){t._updating=false;t._queue.forEach(function(t){t(n,i)});t._queue.splice(0);if(r)q(r);if(n)e(n);else E(i,e)}}function E(t,e){if(n.isArr(t.data)){if(t.data.length){j(t.data);e(null,t)}else{e(new o(1004,t))}}else{e(new o(1001,t))}}function j(t){var e=g();if(e)e.set(t);else y().servers(t)}function q(t){t.forEach(function(t){if(t.xhr){if(t.xhr.readyState!==4)t.xhr.abort()}else{try{t.abort()}catch(e){}}});t.splice(0)}}function a(t){return!t||t.toUpperCase()==="GET"?"read":"write"}function f(t,e){if(t){return t.code!==undefined||c(t)}else if(e){return c(e)}}function c(t){return t.status>=429||t.status===0}function l(t){t=t||"";t+=t.indexOf("?")===-1?"?":"&";t+=n.now()+Math.floor(Math.random()*1e4);return t}},{"./error":4,"./http":5,"./servers":11,"./utils":12}],9:[function(t,e,r){var n=t("./utils");var i=t("./options");var o=t("./client");var s=["get","post","put","del","head","patch"];e.exports=u;function u(t){this._queue=[];this._updating=false;this._client=new o(this);this.setOptions(t)}u.prototype.setOptions=function(t,e){var r=null;if(t&&n.isObj(e)){r=this.options.get(t);if(r instanceof i)r.set(e)}else{this.options=i.define(t)}};u.prototype.setDiscoveryOptions=function(t){this.setOptions("discovery",t);return this};u.prototype.setClientOptions=function(t){this.setOptions("client",t);return this};u.prototype.getOptions=function(t){return t?this.options.get(t):this.options};u.prototype.getDefaults=function(t){return this.options.get(t||"service").http()};u.prototype.getServers=function(){return this.options.get("service").servers()};u.prototype.updateServers=function(){};u.prototype.send=u.prototype.http=function(t,e,r){return this._client.send(t,e,r)};s.forEach(a);function a(t){u.prototype[t]=function(e,r,n){return this._client[t](e,r,n)}}},{"./client":2,"./options":7,"./utils":12}],10:[function(t,e,r){var n=t("./utils");e.exports=i;function i(t,e){this.url=t;this.setStats();this.setOptions(e)}i.prototype.defaults={weight:{request:25,error:50,latency:25}};i.prototype.report=function(t,e,r){var n=this.getStats(t);if(n){n[e]+=1;if(r){n.latency=s(r,n)}}};i.prototype.getBalance=function(t){var e=this.getStats(t);var r=e.request+e.error;var n=this.options.weight;var i=r===0?0:u((e.request*100/r*n.request+e.error*100/r*n.error+e.latency*n.latency)/100);return i};i.prototype.getStats=function(t,e){var r=this.stats[t||"read"];if(r&&e)r=r[e];return r};i.prototype.setOptions=function(t){this.options=n.extend({},this.defaults,t)};i.prototype.setStats=function(t){this.stats=t||{read:o(),write:o()}};function o(){return{latency:0,error:0,request:0}}function s(t,e){return u((t+e.latency)/(e.request+e.error))}function u(t){return Math.round(t*100)/100}},{"./utils":12}],11:[function(t,e,r){var n=t("./utils");var i=t("./server");var o=/^http[s]?\:\/\/(.+)/i;e.exports=s;function s(t,e){this.servers=[];this.updated=0;this.options=e;if(n.isArr(t))this.set(t)}s.prototype.bestAvailable=function(t){var e,r,n=this.servers;var i=n[0];for(e=1,r=n.length;e<r;e+=1){if(n[e].getBalance(t)<i.getBalance(t)){i=n[e]}}return i};s.prototype.sort=function(t){return this.servers.slice(0).sort(function(e,r){return e.getBalance(t)-r.getBalance(t)})};s.prototype.find=function(t){var e,r,n=null;for(e=0,r=this.servers.length;e<r;e+=1){if(this.servers[e].url===t){n=this.servers[e];break}}return n};s.prototype.set=function(t){this.updated=n.now();this.servers=t.filter(u).map(a(this))};s.prototype.lastUpdate=function(){return n.now()-this.updated};s.prototype.empty=function(){return this.servers.length===0};s.prototype.exists=function(){return this.servers.length>0};function u(t){if(n.isObj(t))t=t.url||t.uri;return typeof t==="string"&&o.test(t)}function a(t){return function(e){var r;if(e instanceof i){r=e}else{r=t.find(n.isObj(e)?e.url:e);if(!r)r=new i(e)}return r}}},{"./server":10,"./utils":12}],12:[function(t,e,r){var n=r;var i=Object.prototype.toString;var o=Array.prototype.slice;var s=Object.prototype.hasOwnProperty;var u=Array.isArray;var a=Function.prototype.bind;n.noop=function(){};n.now=function(){return(new Date).getTime()};n.isObj=function(t){return t&&i.call(t)==="[object Object]"||false};n.isArr=function(t){return t&&u?u(t):i.call(t)==="[object Array]"||false};n.bind=function(t,e){return a?e.bind(t):function(){return e.apply(t,arguments)}};n.each=function(t,e){var r,i;if(n.isArr(t))for(r=0,i=t.length;r<i;r+=1)e(t[r],r);else if(n.isObj(t))for(r in t)if(s.call(t,r))e(r,t[r])};n.extend=function(t){var e=o.call(arguments,1);n.each(e,function(e){if(n.isObj(e)){n.each(e,function(e,r){t[e]=r})}});return t};n.clone=function(t){return n.extend({},t)};n.omit=function(t,e){var r,i={};if(n.isObj(t)){for(r in t)if(s.call(t,r)){if(e.indexOf(r)===-1)i[r]=t[r]}}return i};n.pick=function(t,e){var r={};if(n.isObj(t)){Object.keys(t).filter(function(t){return e.indexOf(t)!==-1}).forEach(function(e){return r[e]=t[e]})}return r};n.delay=function(t,e){setTimeout(t,e||1)};n.join=function(t){return(t||"")+o.call(arguments,1).filter(function(t){return typeof t==="string"&&t.length>0}).join("")}},{}],13:[function(t,e,r){},{}]},{},[6])(6)});
//# sourceMappingURL=resilient.min.js.map